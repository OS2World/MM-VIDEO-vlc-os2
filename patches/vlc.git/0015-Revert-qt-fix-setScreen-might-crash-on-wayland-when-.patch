From c6565fc4f0f869f6b05c3617cacd950f0fae7172 Mon Sep 17 00:00:00 2001
From: KO Myung-Hun <komh@chollian.net>
Date: Fri, 29 Dec 2017 15:54:09 +0900
Subject: [PATCH 15/24] Revert "qt: fix setScreen might crash on wayland when
 entering fullscreen"

This reverts commit 24b436c88a986fcf2cddb3c52e5a067565fc537e.
---
 modules/gui/qt/components/controller.cpp |  9 ---------
 modules/gui/qt/components/controller.hpp |  4 ----
 modules/gui/qt/main_interface.cpp        | 17 +----------------
 modules/gui/qt/main_interface.hpp        |  4 +---
 4 files changed, 2 insertions(+), 32 deletions(-)

diff --git a/modules/gui/qt/components/controller.cpp b/modules/gui/qt/components/controller.cpp
index 19666291d6..19f0e29ff5 100644
--- a/modules/gui/qt/components/controller.cpp
+++ b/modules/gui/qt/components/controller.cpp
@@ -799,10 +799,6 @@ FullscreenControllerWidget::FullscreenControllerWidget( intf_thread_t *_p_i, QWi
     b_fullscreen        = false;
     i_hide_timeout      = 1;
     i_screennumber      = -1;
-#ifdef QT5_HAS_WAYLAND
-    b_hasWayland = QGuiApplication::platformName()
-           .startsWith(QLatin1String("wayland"), Qt::CaseInsensitive);
-#endif
 
     vout.clear();
 
@@ -874,12 +870,7 @@ void FullscreenControllerWidget::restoreFSC()
             return;
 
         QRect currentRes = QApplication::desktop()->screenGeometry( targetScreen() );
-#ifdef QT5_HAS_WAYLAND
-        if ( !b_hasWayland )
-            windowHandle()->setScreen(QGuiApplication::screens()[targetScreen()]);
-#else
         windowHandle()->setScreen(QGuiApplication::screens()[targetScreen()]);
-#endif
 
         if( currentRes == screenRes &&
             QApplication::desktop()->screen()->geometry().contains( previousPosition, true ) )
diff --git a/modules/gui/qt/components/controller.hpp b/modules/gui/qt/components/controller.hpp
index 1b68db5645..145d8581ae 100644
--- a/modules/gui/qt/components/controller.hpp
+++ b/modules/gui/qt/components/controller.hpp
@@ -310,10 +310,6 @@ private:
 
     bool isWideFSC;
     int i_sensitivity;
-
-#ifdef QT5_HAS_WAYLAND
-    bool b_hasWayland;
-#endif
 };
 
 #endif
diff --git a/modules/gui/qt/main_interface.cpp b/modules/gui/qt/main_interface.cpp
index 463a5e6fe2..00aad2df9d 100644
--- a/modules/gui/qt/main_interface.cpp
+++ b/modules/gui/qt/main_interface.cpp
@@ -150,11 +150,6 @@ MainInterface::MainInterface( intf_thread_t *_p_intf ) : QVLCMW( _p_intf )
     /* Should the UI stays on top of other windows */
     b_interfaceOnTop = var_InheritBool( p_intf, "video-on-top" );
 
-#ifdef QT5_HAS_WAYLAND
-    b_hasWayland = QGuiApplication::platformName()
-        .startsWith(QLatin1String("wayland"), Qt::CaseInsensitive);
-#endif
-
     /**************************
      *  UI and Widgets design
      **************************/
@@ -886,12 +881,7 @@ void MainInterface::setVideoFullScreen( bool fs )
 
             QRect screenres = QApplication::desktop()->screenGeometry( numscreen );
             lastWinScreen = windowHandle()->screen();
-#ifdef QT5_HAS_WAYLAND
-            if( !b_hasWayland )
-                windowHandle()->setScreen(QGuiApplication::screens()[numscreen]);
-#else
             windowHandle()->setScreen(QGuiApplication::screens()[numscreen]);
-#endif
 
             /* To be sure window is on proper-screen in xinerama */
             if( !screenres.contains( pos() ) )
@@ -917,13 +907,8 @@ void MainInterface::setVideoFullScreen( bool fs )
     {
         setMinimalView( b_minimalView );
         setInterfaceFullScreen( b_interfaceFullScreen );
-#ifdef QT5_HAS_WAYLAND
-        if( lastWinScreen != NULL && !b_hasWayland )
+        if (lastWinScreen != NULL)
             windowHandle()->setScreen(lastWinScreen);
-#else
-        if( lastWinScreen != NULL )
-            windowHandle()->setScreen(lastWinScreen);
-#endif
         if( lastWinPosition.isNull() == false )
         {
             move( lastWinPosition );
diff --git a/modules/gui/qt/main_interface.hpp b/modules/gui/qt/main_interface.hpp
index b4fe5eb880..e79603f256 100644
--- a/modules/gui/qt/main_interface.hpp
+++ b/modules/gui/qt/main_interface.hpp
@@ -184,9 +184,7 @@ protected:
     bool                 b_pauseOnMinimize;
     bool                 b_maximizedView;
     bool                 b_isWindowTiled;
-#ifdef QT5_HAS_WAYLAND
-    bool                 b_hasWayland;
-#endif
+
     /* States */
     bool                 playlistVisible;       ///< Is the playlist visible ?
 //    bool                 videoIsActive;       ///< Having a video now / THEMIM->hasV
-- 
2.13.3

